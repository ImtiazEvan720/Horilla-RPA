# Function to install Docker
function Install-Docker {
    Write-Output "Downloading Docker Desktop for Windows..."
    $dockerUrl = "https://desktop.docker.com/win/stable/Docker%20Desktop%20Installer.exe"
    $dockerInstaller = "$env:TEMP\DockerDesktopInstaller.exe"
    
    Invoke-WebRequest -Uri $dockerUrl -OutFile $dockerInstaller
    
    Write-Output "Installing Docker Desktop..."
    Start-Process -FilePath $dockerInstaller -ArgumentList @("/silent") -Wait
    
    Write-Output "Docker Desktop installation completed."
}

# Function to install Docker Compose
function Install-DockerCompose {
    Write-Output "Downloading Docker Compose..."
    $composeUrl = "https://github.com/docker/compose/releases/download/v2.16.0/docker-compose-Windows-x86_64.exe"
    $composePath = "$env:ProgramFiles\Docker\Docker\resources\bin\docker-compose.exe"

    Invoke-WebRequest -Uri $composeUrl -OutFile $composePath
    
    Write-Output "Docker Compose installation completed."
}

# Function to wait for Docker service to be ready
function Wait-ForDocker {
    Write-Output "Waiting for Docker daemon to be ready..."
    while (-not (Get-Service -Name "com.docker.service" -ErrorAction SilentlyContinue)) {
        Start-Sleep -Seconds 1
    }
    
    while ((docker info | Out-Null) -ne $null) {
        Start-Sleep -Seconds 1
    }
    
    Write-Output "Docker daemon is ready."
}

# Function to start Docker service
function Start-Docker {
    Write-Output "Starting Docker Desktop..."
    Start-Process -FilePath "$env:ProgramFiles\Docker\Docker\Docker Desktop.exe" -ArgumentList @() -Wait
    
    # Check if Docker service is running
    if (Get-Service -Name "com.docker.service" | Select-Object -ExpandProperty Status -eq "Running") {
        Write-Output "Docker service is running."
    } else {
        Write-Output "Docker service failed to start."
    }
}

# Check if Docker is installed
if (Get-Command docker -ErrorAction SilentlyContinue) {
    Write-Output "Docker is already installed. Skipping Docker installation."
} else {
    Write-Output "Installing Docker..."
    Install-Docker
}

# Check if Docker Compose is installed
if (Test-Path "$env:ProgramFiles\Docker\Docker\resources\bin\docker-compose.exe") {
    Write-Output "Docker Compose is already installed. Skipping Docker Compose installation."
} else {
    Write-Output "Installing Docker Compose..."
    Install-DockerCompose
}

# Start Docker service
Start-Docker

# Wait for Docker to be fully ready
Wait-ForDocker

# Start Docker containers using docker-compose
Write-Output "Starting up Docker containers with docker-compose..."
& "$env:ProgramFiles\Docker\Docker\resources\bin\docker-compose.exe" up -d

Write-Output "Setup completed successfully!"
